<!DOCTYPE html>
<html>

<body>
  <div>
    <div id="player_main_id"></div>
  </div>

  <div class="player_preview" id="player_preview_id"></div>

  <a href="video/aSPicd38y_o">
    <div class="div_hover_prev">
      <img class="image_preview" src="http://img.youtube.com/vi/aSPicd38y_o/0.jpg" alt="">
    </div>
  </a>
  <a href="video/aSPicd38y_o">
    <div class="div_hover_prev">
      <img class="image_preview" src="http://img.youtube.com/vi/5ILCDsYM57k/0.jpg" alt="">
    </div>
  </a>
  <a href="video/aSPicd38y_o">
    <div class="div_hover_prev">
      <img class="image_preview" src="http://img.youtube.com/vi/Kbhxo2kOeu4/0.jpg" alt="">
    </div>
  </a>
  <a href="video/aSPicd38y_o">
    <div class="div_hover_prev">
      <img class="image_preview" src="http://img.youtube.com/vi/XZK-rUghHVE/0.jpg" alt="">
    </div>
  </a>

  <style>
    .div_hover_prev {
      position: relative;
      width: 300px;
      height: 200px;
    }
    
    .player_preview {
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 16px;
      display: none;
    }
    
    .image_preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 16px;
    }
  </style>

  <script>
    //////////// for YT api ///////////
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player_main;
    var player_preview;
    var listOfVideos = [];
    var iter_video = 0;
    /////////////// Initialize main player and preview player /////////////////////
    ///////////////////////////////////////////////////////////////////////////////

    function onYouTubeIframeAPIReady() {
      player_main = new YT.Player('player_main_id', {
        height: '390',
        width: '640',
        host: 'https://www.youtube-nocookie.com',
        videoId: "0UgimeJW1Hc",
        playerVars: {
          'playsinline': 1,
          'modestbranding': 1,
          'showinfo': 0,
          'controls': 1,
        },
        events: {
          'onReady': onMainPlayerReady,
          'onStateChange': onMainPlayerStateChange
        },
      });

      player_preview = new YT.Player('player_preview_id', {
        height: '200',
        width: '300',
        host: 'https://www.youtube-nocookie.com',
        videoId: '0UgimeJW1Hc',
        playerVars: {
          'playsinline': 1,
          'modestbranding': 1,
          'showinfo': 0,
          'controls': 1,
        },
        events: {
          'onReady': onListPlayerReady,
        },
      });
    }

    /////////////// Action on main player  ////////////////////////////////////////
    ///////////////////////////////////////////////////////////////////////////////

    function onMainPlayerReady(event) {
      ////// check if video is unavailable //////
      if (event.target.getDuration() === 0) {
        console.log('unavailable');
      } else {
        ////// play video right away but with mute //////
        // event.target.mute();
        // event.target.playVideo();
      }
    }

    // var done = false;
    function onMainPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        iter_video++;
        event.target.loadVideoById(listOfVideos[iter_video]);
        // event.target.videoId = "G9ToPc1SlWs";
        event.target.playVideo();
      }
    }

    /////////////// Action on the preview player and all preview items ////////////
    ///////////////////////////////////////////////////////////////////////////////

    function onListPlayerReady(event) {
      ////// check if video is unavailable //////
      if (event.target.getDuration() === 0) {
        console.log('unavailable');
      } else {
        player_preview.mute();
        initPreviewElements();
      }
    }

    function initPreviewElements() {
      const num_clips = 4
      var player_preview_container = document.querySelector('#player_preview_id');
      player_preview_container.style.position = 'absolute';
      var elements = document.querySelectorAll('.div_hover_prev');
      var new_elements = []
      for (var i = 0; i < elements.length; i++) {
        if (!(listOfVideos.includes(elements[i].querySelector('img').src.slice(0, -6).split('/').pop()))) {
          new_elements.push(elements[i]);
        }
      }
      // isolate the elements that don't have
      new_elements.forEach(function(element, index) {
        var image_preview = element.querySelector('img');
        var video_id = image_preview.src.slice(0, -6).split('/').pop();
        listOfVideos.push(video_id);
        var mouse_leave_done = true;
        var previewIntervalFunction;
        var previewTimeoutFunction1;
        var previewTimeoutFunction2;
        element.onmouseenter = (event) => {
          if (mouse_leave_done) {
            // leave fraction of seconds
            previewTimeoutFunction1 = setTimeout(function() {
              var elemRect = element.getBoundingClientRect();
              player_preview_container.style.top = (window.pageYOffset + elemRect.top) + 'px';
              player_preview_container.style.left = elemRect.left + 'px';
              player_preview_container.style.display = "block";
              player_preview.loadVideoById(video_id);
              previewTimeoutFunction2 = setTimeout(function() {
                image_preview.style.opacity = 0;
                image_preview.style.transition = 'border-radius 1s';
                image_preview.style.borderRadius = 0;
                player_preview_container.style.transition = 'border-radius 1s';
                player_preview_container.style.borderRadius = 0;
                iter_clip = 1;
                previewIntervalFunction = setInterval(function() {
                  var duration_clip = player_preview.getDuration() / num_clips;
                  if (iter_clip < num_clips) {
                    player_preview.seekTo(iter_clip * duration_clip);
                    iter_clip++;
                  } else {
                    mouse_leave_done = false;
                    image_preview.style.opacity = 1;
                    player_preview.stopVideo();
                    clearInterval(previewIntervalFunction);
                    player_preview_container.style.display = "none";
                  }
                }, 2000);
              }, 200);
            }, 100);
          }
          element.onmouseleave = (event) => {
            image_preview.style.opacity = 1;
            image_preview.style.borderRadius = '16px';
            player_preview_container.style.transition = 'border-radius 0s';
            player_preview_container.style.borderRadius = '16px';
            player_preview_container.style.display = "none";
            clearTimeout(previewTimeoutFunction1);
            clearTimeout(previewTimeoutFunction2);
            clearInterval(previewIntervalFunction);
            player_preview.stopVideo()
            mouse_leave_done = true;
          };
          element.addEventListener('click', function() {
            console.log('Div was clicked!');
          });
        };
      });
    }
    // setTimeout(function() {
    //   console.log("timed");
    //   initPreviewElements();
    // }, 20000);
  </script>
</body>

</html>