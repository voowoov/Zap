{% extends 'main.html' %}
{% load i18n %} {% load static %}
{% block title %}{% trans "Monitor" %}{% endblock %}
{% block desc %}{% trans "" %}{% endblock %}
{% block content %}

<main class="d-flex flex-fill">
  <section class="full_section text_color">
    <div class="h-100 container-fluid">
      <div class="h-100 d-flex gap-2">
        <div class="d-flex flex-column flex-grow-1 gap-1" style="min-width:300px;">
          <textarea class="command-log" id="command-log"></textarea>
          <textarea class="command-input" id="command-input" type="text" rows="2"></textarea>
          <button class="command-submit" id="command-submit">{% trans "Send command" %}</button>
        </div>

        <div class="col-lg-6 col-md-6" style="margin: 100px auto; display: block;">
          <div class="drop-box" id="dropBox" style="width: 100%; height: 400px; border: 4px dashed gray;">
            <p style="text-align: center; vertical-align: middle; line-height: 400px; font-size: 24px; color: gray;">
              Drag & Drop to Upload File</p>
          </div>
          <form enctype="multipart/form-data" method="POST" action="" style="text-align: center;">
            <p style="color: gray; padding-top: 20px;">or</p>
            {% csrf_token %}
            <div class="form-group">
              <label>Select file to upload.</label>
              <input type="file" class="form-control" id="fileupload" placeholder="Select file">
            </div>
            <input type="submit" value="Upload" id="submit" class="btn btn-success">
          </form>
          <div id="uploaded_files"></div>
        </div>

        <div class="d-flex flex-column align-items-start" style="width:250px;">
          Typesense
          <button onclick="sendCommand('movies_fixture_to_db')">movies_fixture_to_db</button>
          <button onclick="sendCommand('delete_all_movies_from_db')">delete_all_movies_from_db</button> -
          <button onclick="sendCommand('typesense_delete_a_collection')">typesense_delete_a_collection</button>
          <button onclick="sendCommand('typesense_create_a_collection')">typesense_create_a_collection</button>
          <button onclick="sendCommand('typesense_import_documents')">typesense_import_documents</button>
          <button onclick="sendCommand('typesense_test_count_documents')">typesense_test_count_documents</button>
          <button onclick="sendCommand('typesense_add_single_document')">typesense_add_single_document</button>
          Websocket tests
          <label> Packet size<input type="text" value="1024" id="wstestsize" style="width:100px;"></label>
          <label> Repetitions<input type="text" value="5" id="wstestrepetitions" style="width:100px;"></label>
          <label> Delay ms<input type="text" value="500" id="wstestdelay" style="width:100px;"></label>
          <button onclick="sendPacketBurstJS()">sendPacketBurstJS</button>
          <button onclick="connectAndDisconnectJS()">connectAndDisconnectJS</button>
          <button onclick="sendCommand('close_connection_in_django')">close_connection_in_django</button>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
  const commandLog = document.querySelector('#command-log');
  const commandInput = document.querySelector('#command-input');
  const commandSubmit = document.querySelector('#command-submit');

  const webSocketURL = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
    window.location.host + '/' +
    document.documentElement.lang + '/ws/monitor/';

  const monitorSocket = new WebSocket(webSocketURL);

  monitorSocket.onmessage = function (e) {
    addLogRes(e.data)
  };

  monitorSocket.onclose = function (e) {
    console.error('Monitor socket closed unexpectedly');
  };

  monitorSocket.onerror = function (event) {
    if (event.code === 1009) {
      alert("The message received was too large.");
    }
  };

  commandInput.onkeydown = function (e) {
    if (e.key === "Enter") { // enter, return
      event.preventDefault();
      commandSubmit.click();
    }
  };

  commandSubmit.onclick = function (e) {
    sendCommand(commandInput.value);
    commandInput.value = '';
  };

  function addLogRes(log) {
    commandLog.value += ('return: ' + log + '\n');
    commandLog.scrollTop = commandLog.scrollHeight;
  }

  function addComlog(log) {
    commandLog.value += ('cmd: ' + log + '\n');
    commandLog.scrollTop = commandLog.scrollHeight;
  }

  function sendCommand(command) {
    if (command.length > 0) {
      monitorSocket.send(command);
      addComlog(command);
    }
  }

  function sendPacketBurstJS() {
    packetSize = parseInt(document.getElementById("wstestsize").value);
    repetitions = parseInt(document.getElementById("wstestrepetitions").value);
    delay = parseInt(document.getElementById("wstestdelay").value);
    const str1 = 'x'.repeat(packetSize);
    console.log('sending ' + repetitions + ' packets of size ' + packetSize)
    let x = 0;
    const intervalId = setInterval(() => {
      if (x === repetitions) {
        clearInterval(intervalId);
        return;
      }
      console.log(x);
      monitorSocket.send(str1);
      x++;
    }, delay);
  }

  function connectAndDisconnectJS() {
    repetitions = parseInt(document.getElementById("wstestrepetitions").value);
    delay = parseInt(document.getElementById("wstestdelay").value);
    let count = 0;
    const intervalId = setInterval(() => {
      if (count % 2 === 0) {
        // First command
        console.log("Connect");
        monitorSocket1 = new WebSocket(webSocketURL);
      } else {
        // Second command
        console.log("Disconnect");
        monitorSocket1.close();
      }
      count++;
      if (count === 2 * repetitions) {
        clearInterval(intervalId);
      }
    }, delay);
  }

  window.addEventListener('beforeunload', function (event) {
    monitorSocket.close();
  });
</script>

/////////////////// upload files ////////////////////////////

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
  class FileUpload {

    constructor(input) {
      this.input = input
      this.max_length = 1024 * 1024 * 10;
    }

    create_progress_bar() {
      var progress = `<div class="file-icon">
                            <i class="fa fa-file-o" aria-hidden="true"></i>
                        </div>
                        <div class="file-details">
                            <p class="filename"></p>
                            <small class="textbox"></small>
                            <div class="progress" style="margin-top: 5px;">
                                <div class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                </div>
                            </div>
                        </div>`
      document.getElementById('uploaded_files').innerHTML = progress
    }

    upload() {
      this.create_progress_bar();
      this.initFileUpload();
    }

    initFileUpload() {
      this.file = this.input.files[0];
      this.upload_file(0, null);
    }

    //upload file
    upload_file(start, model_id) {
      var end;
      var self = this;
      var existingPath = model_id;
      var formData = new FormData();
      var nextChunk = start + this.max_length + 1;
      var currentChunk = this.file.slice(start, nextChunk);
      var uploadedChunk = start + currentChunk.size
      if (uploadedChunk >= this.file.size) {
        end = 1;
      } else {
        end = 0;
      }
      formData.append('file', currentChunk)
      formData.append('filename', this.file.name)
      $('.filename').text(this.file.name)
      $('.textbox').text("Uploading file")
      formData.append('end', end)
      formData.append('existingPath', existingPath);
      formData.append('nextSlice', nextChunk);
      $.ajaxSetup({
        headers: {
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
      });
      $.ajax({
        xhr: function () {
          var xhr = new XMLHttpRequest();
          xhr.upload.addEventListener('progress', function (e) {
            if (e.lengthComputable) {
              if (self.file.size < self.max_length) {
                var percent = Math.round((e.loaded / e.total) * 100);
              } else {
                var percent = Math.round((uploadedChunk / self.file.size) * 100);
              }
              $('.progress-bar').css('width', percent + '%')
              $('.progress-bar').text(percent + '%')
            }
          });
          return xhr;
        },

        url: '',
        type: 'POST',
        dataType: 'json',
        cache: false,
        processData: false,
        contentType: false,
        data: formData,
        error: function (xhr) {
          alert(xhr.statusText);
        },
        success: function (res) {
          if (nextChunk < self.file.size) {
            // upload file in chunks
            existingPath = res.existingPath
            self.upload_file(nextChunk, existingPath);
          } else {
            // upload complete
            $('.textbox').text(res.data);
            alert(res.data)
          }
        }
      });
    };
  }

  (function ($) {
    $('#submit').on('click', (event) => {
      event.preventDefault();
      var uploader = new FileUpload(document.querySelector('#fileupload'))
      console.log(document.querySelector('#fileupload'));
      uploader.upload();
    });
  })(jQuery);

  ondragenter = function (evt) {
    evt.preventDefault();
    evt.stopPropagation();
  };

  ondragover = function (evt) {
    evt.preventDefault();
    evt.stopPropagation();
  };

  ondragleave = function (evt) {
    evt.preventDefault();
    evt.stopPropagation();
  };

  ondrop = function (evt) {
    evt.preventDefault();
    evt.stopPropagation();
    const files = evt.originalEvent.dataTransfer;
    var uploader = new FileUpload(files);
    uploader.upload();
  };

  $('#dropBox')
    .on('dragover', ondragover)
    .on('dragenter', ondragenter)
    .on('dragleave', ondragleave)
    .on('drop', ondrop);
</script>



<style>
  .command-log {
    width: 100%;
    height: 100%;
    resize: none;
    background: var(--color-cmd-bg);
    color: var(--color-text);
  }

  .command-input {
    width: 100%;
    resize: none;
    background: var(--color-cmd-bg);
    color: var(--color-text);
  }

  .command-submit {
    width: 100%;
    resize: none;
    background: var(--color-cmd-bg);
    color: var(--color-text);
  }


  #myProgress {
    width: 100%;
  }

  #uploaded_files {
    margin-top: 25px;
    display: flex;
  }

  label {
    font-weight: bold;
  }

  .file-icon i {
    font-size: 60px;
    color: rgb(0, 0, 0);
  }

  .file-details {
    margin-top: -2px;
    padding-left: 10px;
    width: 100%;
  }

  .file-details p {
    margin-bottom: -7px;
  }

  small {
    margin-top: 0;
    color: black;
  }
</style>

{% endblock %}