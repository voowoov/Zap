{% extends 'main.html' %}
{% load i18n %} {% load static %}
{% block title %}{% trans "Searcu" %}{% endblock %}
{% block desc %}{% trans "" %}{% endblock %}
{% get_current_language as CURRENT_LANGUAGE %}
{% block content %}

<main class="d-flex flex-fill">
  <section id="login_section" class="login_section">
    <div class="container-fluid">
      <div class="row text_color text-start">
        <input type="text" id="navsearchinput" oninput="sendWebSocketMessage()" />
        <div id="navsearchresultsctn"></div>
        {{ CURRENT_LANGUAGE|json_script:"current-language" }}
      </div>
    </div>
  </section>
</main>
<script>
  var websocketnavsearch; // Declare a global variable for the WebSocket object

  function createWebSocketNavsearch() {
    const currentLanguage = JSON.parse(document.getElementById('current-language').textContent);
    const currenthttpprotocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    websocketnavsearch = new WebSocket(
      currenthttpprotocol +
      window.location.host + '/' +
      currentLanguage + '/ws/search/'
    );
    // Handle WebSocket connection open event
    websocketnavsearch.onopen = function (event) {
      console.log('WebSocket connection established.');
    };

    // Handle WebSocket message received event
    websocketnavsearch.onmessage = function (event) {
      const message = event.data;
      handleWebSocketMessageNavsearch(message);
    };

    // Handle WebSocket connection close event
    websocketnavsearch.onclose = function (event) {
      console.log('WebSocket connection closed.');
    };

    websocketnavsearch.onerror = function (event) {
      // Handle the error event
      console.log("WebSocket error: " + event.message);
    };
  }

  const navsearchinputele = document.getElementById('navsearchinput');
  navsearchinputele.addEventListener("focus", function (event) {
    if (!websocketnavsearch) {
      createWebSocketNavsearch();
    }
  });

  // Send a WebSocket message to the Django consumer
  function sendWebSocketMessage() {
    const inputText = navsearchinputele.value;
    startTimerNavsearch = performance.now();
    // Send the input text as a WebSocket message
    websocketnavsearch.send(inputText);
  }

  const navsearchResultsctn = document.getElementById('navsearchresultsctn');
  // Handle WebSocket message received from the Django consumer
  function handleWebSocketMessageNavsearch(message) {
    var jsonArray = JSON.parse(message);
    var ul = document.createElement("ul");
    for (var i = 0; i < jsonArray.length; i++) {
      // Create a list item element
      var li = document.createElement("li");
      // Set the content of the list item to the name and age of each person
      li.innerHTML = jsonArray[i].title + " (" + jsonArray[i].vote + ")";
      // Append the list item to the list
      ul.appendChild(li);
    }
    navsearchResultsctn.innerHTML = "";
    navsearchResultsctn.appendChild(ul);

    let timeDiff = performance.now() - startTimerNavsearch;
    console.log(`${timeDiff} milliseconds to execute.`);
  }
</script>
{% include 'base/footers/footer_small.html' %}

{% endblock %}